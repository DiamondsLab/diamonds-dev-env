name: Create branch from issue

on:
  issues:
    types: [opened, labeled]

permissions:
  contents: write

jobs:
  create-branch:
    if: github.event.issue.pull_request == null
    runs-on: ubuntu-latest
    steps:
      - name: Create branch based on issue
        uses: actions/github-script@v6
        with:
          script: |
            const issue = context.payload.issue;
            const repo = context.repo.repo;
            const owner = context.repo.owner;

            // Choose type from labels (customize this list)
            const labelNames = (issue.labels || []).map(l => l.name.toLowerCase());
            const allowedTypes = ['bug', 'feature', 'chore', 'docs', 'task'];
            let issueType = 'task';
            for (const t of allowedTypes) {
              if (labelNames.includes(t)) { issueType = t; break; }
            }

            // Build a URL-safe slug from title
            function slugify(s) {
              return s.toLowerCase()
                .replace(/[^a-z0-9\s-]/g, '')    // remove invalid chars
                .replace(/\s+/g, '-')            // collapse whitespace to dash
                .replace(/-+/g, '-')             // collapse dashes
                .replace(/(^-|-$)/g, '')         // trim leading/trailing dash
                .slice(0, 60);                   // limit length
            }

            const number = issue.number;
            const titleSlug = slugify(issue.title || `issue-${number}`);
            const branchName = `${issueType}/${number}-${titleSlug}`;

            // get default branch
            const { data: repoData } = await github.rest.repos.get({ owner, repo });
            const baseBranch = repoData.default_branch;

            // get sha of base branch
            const refName = `heads/${baseBranch}`;
            const { data: refData } = await github.rest.git.getRef({ owner, repo, ref: `refs/${refName}` });
            const sha = refData.object.sha;

            // attempt to create branch
            const fullRef = `refs/heads/${branchName}`;
            try {
              await github.rest.git.createRef({ owner, repo, ref: fullRef, sha });
              core.info(`Created branch: ${branchName}`);
            } catch (err) {
              if (err.status === 422) {
                core.info(`Branch ${branchName} already exists â€” skipping creation.`);
              } else {
                throw err;
              }
            }
