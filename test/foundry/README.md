# Foundry Tests

This directory contains Foundry-based tests for the Diamond contracts, leveraging the **Forge Fuzzing Framework** for comprehensive testing.

## Directory Structure

```
test/foundry/
‚îú‚îÄ‚îÄ helpers/
‚îÇ   ‚îú‚îÄ‚îÄ DiamondDeployment.sol           # üîÑ Auto-generated - DO NOT EDIT
‚îÇ   ‚îú‚îÄ‚îÄ DiamondFuzzBase.sol             # Base contract for Diamond tests
‚îÇ   ‚îî‚îÄ‚îÄ DiamondABILoader.sol            # ABI parsing utilities
‚îú‚îÄ‚îÄ fuzz/
‚îÇ   ‚îú‚îÄ‚îÄ ExampleDiamondAccessControl.t.sol
‚îÇ   ‚îî‚îÄ‚îÄ ExampleDiamondOwnership.t.sol
‚îú‚îÄ‚îÄ integration/
‚îÇ   ‚îî‚îÄ‚îÄ ExampleDiamondIntegrationDeployed.t.sol
‚îú‚îÄ‚îÄ invariant/
‚îÇ   ‚îî‚îÄ‚îÄ DiamondProxyInvariant.t.sol
‚îî‚îÄ‚îÄ ExampleDiamond.forge.config.json    # Forge test configuration
```

## Test Categories

### Fuzz Tests (`fuzz/`)

Property-based tests using random inputs to discover edge cases.

**Examples**:

- `ExampleDiamondAccessControl.t.sol` - Access control fuzzing (7 tests)
- `ExampleDiamondOwnership.t.sol` - Ownership fuzzing (7 tests)

**Key Pattern**:

```solidity
function testFuzz_Something(address user, uint256 value) public {
    vm.assume(user != address(0));  // Constrain inputs
    vm.assume(value > 0);

    // Test logic
}
```

### Integration Tests (`integration/`)

End-to-end tests verifying complete workflows on deployed Diamond.

**Examples**:

- `ExampleDiamondIntegrationDeployed.t.sol` - Facet introspection, gas profiling (11 tests)

**Key Pattern**:

```solidity
function test_CompleteWorkflow() public view {
    // Verify deployment
    assertTrue(diamond != address(0));

    // Test facet interactions
    bytes4 selector = bytes4(keccak256("facets()"));
    (bool success, bytes memory data) = diamond.staticcall(...);

    // Assertions
}
```

### Invariant Tests (`invariant/`)

Tests that verify properties that should always hold true.

**Examples**:

- `DiamondProxyInvariant.t.sol` - Diamond integrity invariants (11 invariants)

**Key Pattern**:

```solidity
function invariant_DiamondExists() public view {
    assertTrue(diamond != address(0));
    assertTrue(diamond.code.length > 0);
}
```

## Quick Start

### 1. Deploy Diamond and Generate Helpers

```bash
# Start local network (separate terminal)
npx hardhat node

# Deploy Diamond
yarn forge:deploy
```

This will:

- Deploy ExampleDiamond to localhost
- Generate `helpers/DiamondDeployment.sol` with deployment data
- Create deployment record in `diamonds/ExampleDiamond/deployments/`

### 2. Run Tests

```bash
# Run all Forge tests
yarn forge:fuzz

# Or use direct forge commands
forge test -vv

# Run specific test file
forge test --match-path test/foundry/fuzz/ExampleDiamondAccessControl.t.sol

# Run specific test function
forge test --match-test testFuzz_GrantRole -vvv
```

## Helper Library

### DiamondDeployment.sol (Auto-Generated)

**‚ö†Ô∏è DO NOT EDIT THIS FILE MANUALLY**

This file is automatically generated by `forge:deploy` and contains:

- Diamond contract address
- Facet addresses as constants
- Function selectors as constants
- Helper functions for accessing deployment data

**Regenerate**:

```bash
yarn forge:generate-helpers
```

**Example Usage**:

```solidity
import "@helpers/DiamondDeployment.sol";

address diamond = DiamondDeployment.getDiamondAddress();
address facet = DiamondDeployment.getFacetAddress("ExampleOwnershipFacet");
```

### DiamondFuzzBase.sol (Extend This)

Base contract providing helper functions for Diamond testing:

**Key Functions**:

```solidity
// Load Diamond address
diamond = _loadDiamondAddress();

// Call Diamond functions
(bool success, bytes memory data) = _callDiamond(selector, args);

// Get Diamond state
address owner = _getDiamondOwner();
bool hasRole = _hasRole(role, account);

// Verify facet routing
address facet = _verifyFacetRouting(selector, expectedFacet);

// Measure gas
uint256 gas = _measureDiamondGas(selector, args);
```

**Usage in Tests**:

```solidity
import "../helpers/DiamondFuzzBase.sol";

contract MyTest is DiamondFuzzBase {
    function setUp() public override {
        super.setUp();  // Essential!
        // Your setup
    }

    function test_Something() public {
        // Use helper functions
        address owner = _getDiamondOwner();
        // ...
    }
}
```

## Writing New Tests

### 1. Create Test File

```bash
# Fuzz test
touch test/foundry/fuzz/MyNewFuzzTest.t.sol

# Integration test
touch test/foundry/integration/MyIntegrationTest.t.sol

# Invariant test
touch test/foundry/invariant/MyInvariantTest.t.sol
```

### 2. Use Template

```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.19;

import "../helpers/DiamondFuzzBase.sol";

/// @title MyNewFuzzTest
/// @notice Description of what this tests
contract MyNewFuzzTest is DiamondFuzzBase {

    function setUp() public override {
        super.setUp();
        // Additional setup
    }

    /// @notice Test description
    function test_MyFeature() public {
        // Test implementation
    }
}
```

### 3. Run Your Test

```bash
# Run single test file
forge test --match-path test/foundry/fuzz/MyNewFuzzTest.t.sol -vv

# Run specific function
forge test --match-test test_MyFeature -vvv
```

## Configuration

### foundry.toml

Global Forge configuration:

```toml
[profile.default]
src = "contracts"
test = "test/foundry"
fuzz = { runs = 256, max_test_rejects = 65536 }
```

### ExampleDiamond.forge.config.json

Diamond-specific fuzzing configuration:

```json
{
  "forgeSettings": {
    "runs": 256,
    "depth": 15,
    "workers": 4,
    "verbosity": 2
  },
  "networkSettings": {
    "defaultNetwork": "localhost",
    "rpcUrl": "http://127.0.0.1:8545"
  }
}
```

## Best Practices

### ‚úÖ Do

- **Extend DiamondFuzzBase** for all Diamond tests
- **Call super.setUp()** in your setUp() function
- **Use vm.assume()** to constrain fuzz inputs
- **Document test purpose** with NatSpec comments
- **Use descriptive test names** (e.g., `testFuzz_GrantRole_RevertsForUnauthorized`)
- **Keep tests isolated** - each test should be independent
- **Measure gas** for optimization-critical functions

### ‚ùå Don't

- **Edit DiamondDeployment.sol** manually (it's auto-generated)
- **Forget super.setUp()** - tests will fail
- **Skip input constraints** in fuzz tests
- **Hardcode addresses** - use DiamondDeployment library
- **Write stateful tests** without cleanup

## Common Patterns

### Testing Access Control

```solidity
function testFuzz_OnlyAdminCanDoX(address user) public {
    vm.assume(user != address(0));
    vm.assume(user != admin);

    vm.prank(user);
    bytes4 selector = bytes4(keccak256("restrictedFunction()"));
    (bool success,) = _callDiamond(selector, "");

    assertFalse(success, "Should revert for non-admin");
}
```

### Testing Ownership

```solidity
function testFuzz_TransferOwnership(address newOwner) public {
    vm.assume(newOwner != address(0));

    address currentOwner = _getDiamondOwner();

    vm.prank(currentOwner);
    bytes4 selector = bytes4(keccak256("transferOwnership(address)"));
    (bool success,) = _callDiamond(selector, abi.encode(newOwner));

    assertTrue(success);
    assertEq(_getDiamondOwner(), newOwner);
}
```

### Testing Invariants

```solidity
function invariant_OwnerNeverZero() public view {
    address owner = _getDiamondOwner();
    assertTrue(owner != address(0));
}
```

### Gas Profiling

```solidity
function test_Gas_OwnerCall() public {
    bytes4 selector = bytes4(keccak256("owner()"));
    uint256 gas = _measureDiamondGas(selector, "");

    console.log("Gas used:", gas);
    assertLt(gas, 10000, "Should use less than 10k gas");
}
```

## Troubleshooting

### "Diamond not deployed"

```bash
# Deploy Diamond first
yarn forge:deploy
```

### "DiamondDeployment not found"

```bash
# Regenerate helper library
yarn forge:generate-helpers

# Verify remapping in foundry.toml
grep "@helpers/" ../../foundry.toml
```

### "setUp() reverts"

Make sure you call `super.setUp()`:

```solidity
function setUp() public override {
    super.setUp();  // Must be first!
    // Your setup
}
```

### Tests fail after redeployment

```bash
# Regenerate helpers with new deployment data
yarn forge:generate-helpers
```

### Import not found

Check `foundry.toml` has correct remapping:

```toml
remappings = [
    "@helpers/=test/foundry/helpers/",
    # ...
]
```

## Test Statistics

**Current Test Coverage**:

- Fuzz tests: 14 test functions
- Integration tests: 11 test functions
- Invariant tests: 11 invariant checks
- **Total**: 36 test functions

**Test Execution**:

- Fuzz runs per test: 256 (configurable)
- Average execution time: ~12-15 seconds (all tests)
- Test success rate: 100%

## Additional Resources

- **Comprehensive Guide**: [../../docs/FORGE_FUZZING_GUIDE.md](../../docs/FORGE_FUZZING_GUIDE.md)
- **Foundry Book**: https://book.getfoundry.sh/
- **Forge Std Cheatcodes**: https://book.getfoundry.sh/cheatcodes/
- **Diamond Standard**: https://eips.ethereum.org/EIPS/eip-2535

## Workflow Summary

```bash
# 1. Start network
npx hardhat node

# 2. Deploy and setup
yarn forge:deploy

# 3. Run tests
yarn forge:fuzz

# 4. Develop
# - Edit tests in fuzz/, integration/, or invariant/
# - Run specific tests: forge test --match-test <name>
# - Check gas: yarn forge:test:gas

# 5. After Diamond changes
yarn forge:deploy --force-deploy  # Redeploy and regenerate helpers
```

---

**Happy Testing! üß™**

For questions or issues, see the [troubleshooting section](#troubleshooting) or refer to the [comprehensive guide](../../docs/FORGE_FUZZING_GUIDE.md).
